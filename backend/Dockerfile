FROM node:20-alpine AS base

ENV NODE_ENV=production
ENV NODE_PATH=/app/backend/node_modules:/app/node_modules
WORKDIR /app/backend

# Copy manifests first for better caching
# ğŸš¨ ä¿®æ­£: 'backend/' ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã€‚ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰æ¢ã™ãŸã‚ã€‚
COPY package.json ./package.json 
COPY db /app/db

# Install backend deps (file:../db will resolve because /app/db exists)
RUN --mount=type=cache,target=/root/.npm npm install --omit=dev \
    && mkdir -p /app/node_modules \
    && cp -r node_modules/* /app/node_modules/ || true

# Copy sources
# ğŸš¨ ä¿®æ­£: 'backend' ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã€‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã€‚
COPY . .

EXPOSE 3000
CMD ["node", "server.js"]
